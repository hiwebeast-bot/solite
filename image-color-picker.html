<!DOCTYPE html>
<html lang="en" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO & Social Sharing Meta Tags -->
    <!-- MODIFIED: Optimized Title -->
    <title>Free Image Color Picker & Palette Generator | Solite</title>
    <!-- MODIFIED: Optimized Description -->
    <meta name="description" content="Extract colors & create palettes from images with this free online color picker tool. Eyedropper finds HEX, RGB, HSL codes instantly. 100% private & browser-based.">
    <!-- MODIFIED: Expanded Keywords -->
    <meta name="keywords" content="image color picker, color picker from image, online color picker, eyedropper tool, color palette generator, hex color picker, rgb color picker, hsl color picker, accessibility contrast checker, solite, free tool">
    <link rel="canonical" href="https://solite.in/image-color-picker.html" />
    <meta name="robots" content="index, follow">

    <!-- Open Graph for social + AI -->
    <!-- MODIFIED: Optimized OG Title -->
    <meta property="og:title" content="Free Image Color Picker & Palette Generator | Solite">
    <meta property="og:description" content="Free browser-based image color picker. Upload an image, use the eyedropper, get HEX/RGB/HSL codes, check contrast, and build palettes. No login required.">
    <meta property="og:url" content="https://solite.in/image-color-picker.html">
    <meta property="og:site_name" content="Solite App Suite">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://solite.in/assets/image-color-picker-thumbnail.png">

    <!-- AdSense Meta Tag -->
    <meta name="google-adsense-account" content="ca-pub-6623613371208692">

    <!-- Vercel Analytics -->
    <script>
        window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js" defer></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Favicon Set -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#000000">
    
    <!-- Schema.org Markup -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Image Color Picker | Solite", // MODIFIED: Added Solite
      "url": "https://solite.in/image-color-picker.html",
      "description": "A free, client-side tool to extract color palettes from images using an eyedropper with zoom. Provides HEX, RGB, HSL codes and accessibility contrast ratios.",
      "applicationCategory": "DesignApplication",
      "featureList": [
        "Upload images (PNG, JPG, etc.)",
        "Eyedropper tool with zoom loupe for precise color selection",
        "Extract HEX, RGB, and HSL color codes",
        "WCAG AA contrast ratio checker for accessibility",
        "Build and manage a palette of picked colors",
        "Copy individual or all picked colors"
      ],
      "operatingSystem": "All",
      "browserRequirements": "Requires a modern web browser with JavaScript enabled.",
      "provider": {
        "@type": "Organization",
        "name": "Solite",
        "url": "https://solite.in/"
      },
      "dateModified": "2025-11-06T10:00:00Z",
      "mainEntity": {
        "@type": "HowTo",
        "name": "How to Pick Colors from an Image",
        "step": [
          { "@type": "HowToStep", "name": "Step 1: Upload Image", "text": "Drag and drop an image onto the page or click to select a file from your device." },
          { "@type": "HowToStep", "name": "Step 2: Pick Colors", "text": "Move your mouse over the image to see a zoomed-in loupe and live color values. Click on the image to add a color to your palette." },
          { "@type": "HowToStep", "name": "Step 3: Copy or Clear", "text": "Click on any color in your palette to copy its HEX code. You can also copy all colors at once or clear the palette to start over." }
        ]
      }
    },
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://solite.in/index.html"
      },{
        "@type": "ListItem",
        "position": 2,
        "name": "Image Color Picker"
      }]
    }
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        :is(button, a, select, input):focus-visible {
            outline: none; box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
        }
        #image-canvas { cursor: crosshair; }
        #toast { transform: translateY(150%); transition: transform 0.3s ease-in-out; z-index: 9999; }
        #toast.show { transform: translateY(-2rem); }
        #zoom-loupe {
            position: absolute;
            width: 128px;
            height: 128px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            pointer-events: none;
            display: none;
            overflow: hidden;
            background-color: #111;
            z-index: 10;
        }
        /* Custom Scrollbar for Webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; /* gray-900 */
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        /* Custom Scrollbar for Firefox */
        html { scrollbar-color: #4b5563 #111827; }

        /* ADDED: Mobile Nav Styles */
        .mobile-nav-btn.active {
            color: #ffffff; /* white */
        }
        .mobile-nav-btn {
            color: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="bg-black text-gray-200 flex flex-col min-h-screen font-sans">
    
    <!-- MODIFIED: Header updated to mobile-first version -->
    <header class="p-3 sm:p-4 w-full flex-shrink-0 sticky top-0 bg-white/80 dark:bg-black/80 backdrop-blur-xl z-30 border-b border-gray-200 dark:border-gray-800">
        <div class="flex justify-between items-center">
            <a href="index.html" class="flex flex-col space-y-1 lg:flex-row lg:items-center lg:space-x-3 lg:space-y-0" aria-label="Solite Homepage">
                <div class="flex items-center space-x-3">
                     <svg class="h-6 w-6 lg:h-8 lg:w-8 text-gray-900 dark:text-white flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2L2 7l10 5 10-5L12 2z"></path>
                        <path d="M2 17l10 5 10-5"></path>
                        <path d="M2 7l10 5 10-5"></path>
                    </svg>
                    <span class="text-base lg:text-xl font-bold text-gray-900 dark:text-white uppercase tracking-wider leading-none">Solite</span>
                </div>
                <span class="h-6 w-px bg-gray-300 dark:bg-gray-700 hidden lg:block"></span>
                <span class="text-lg lg:text-lg font-semibold text-gray-600 dark:text-gray-400 leading-none">Image Color Picker</span>
            </a>
             <div class="flex items-center space-x-4">
                <a href="index.html#apps" class="bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 text-gray-800 dark:text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center space-x-1.5">
                    <span>Free Tools</span>
                    <svg class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5-5 5"></path></svg>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <!-- MODIFIED: Added relative, min-h-0 -->
    <main class="flex-grow flex relative min-h-0" style="height: calc(100vh - 72px);">
        <!-- MODIFIED: Added pb-16 for mobile nav clearance, added min-h-0 -->
        <div class="flex-grow w-full lg:w-[80%] p-3 pb-16 lg:pb-3 flex flex-col lg:flex-row gap-4 min-h-0">
            
            <!-- Image Display Area / Picker Pane -->
            <!-- MODIFIED: Added id="picker-pane", overflow-auto -->
            <div id="picker-pane" class="flex-1 flex flex-col items-center justify-center bg-gray-900 rounded-xl border-2 border-dashed border-gray-700 relative overflow-auto">
                <div id="image-container" class="flex items-center justify-center w-full h-full p-2">
                    <div id="upload-prompt" class="text-center cursor-pointer p-8">
                        <!-- MODIFIED: Added screen-reader only H1 -->
                        <h1 class="sr-only">Image Color Picker & Palette Generator</h1>
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <p class="mt-2 text-lg font-medium text-white">Drop an image or click to upload</p>
                        <p class="mt-1 text-sm text-gray-400">Your image stays on your device.</p>
                    </div>
                    <!-- MODIFIED: Removed max-w-full max-h-full object-contain -->
                    <canvas id="image-canvas" class="hidden"></canvas>
                    <input type="file" id="image-upload" class="hidden" accept="image/*">
                    <div id="zoom-loupe"></div>
                </div>
            </div>

            <!-- Controls & Palette Panel -->
            <!-- MODIFIED: Added id="palette-pane", overflow-y-auto -->
            <div id="palette-pane" class="w-full lg:w-96 flex-shrink-0 bg-gray-900 rounded-xl border border-gray-800 p-6 space-y-6 overflow-y-auto">
                <div id="color-info-section" class="hidden">
                    <h3 class="font-semibold text-white mb-2">Hovered Color</h3>
                    <div class="flex items-center gap-4">
                        <div id="hover-color-preview" class="w-20 h-20 rounded-lg border-2 border-gray-700 bg-gray-800"></div>
                        <div class="space-y-1 font-mono text-sm w-full">
                            <div class="flex items-center justify-between gap-4"><span class="text-gray-400">HEX</span> <span id="hover-color-hex">#000000</span> <button class="copy-format-btn" data-format="hex" aria-label="Copy HEX code" title="Copy HEX"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button></div>
                            <div class="flex items-center justify-between gap-4"><span class="text-gray-400">RGB</span> <span id="hover-color-rgb">0, 0, 0</span> <button class="copy-format-btn" data-format="rgb" aria-label="Copy RGB code" title="Copy RGB"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button></div>
                            <div class="flex items-center justify-between gap-4"><span class="text-gray-400">HSL</span> <span id="hover-color-hsl">0, 0, 0</span> <button class="copy-format-btn" data-format="hsl" aria-label="Copy HSL code" title="Copy HSL"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button></div>
                        </div>
                    </div>
                    <div id="contrast-info" class="mt-4 space-y-2 text-sm">
                        <h4 class="font-semibold text-white">Accessibility (WCAG AA)</h4>
                        <div class="flex justify-between items-center"><span class="text-gray-400">vs White Text</span> <span id="contrast-white" class="font-mono">1.0</span> <span id="contrast-white-pass" class="text-red-400 font-bold">Fail</span></div>
                        <div class="flex justify-between items-center"><span class="text-gray-400">vs Black Text</span> <span id="contrast-black" class="font-mono">21.0</span> <span id="contrast-black-pass" class="text-green-400 font-bold">Pass</span></div>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-white mb-2">Picked Palette</h3>
                    <div id="picked-colors-palette" class="grid grid-cols-8 gap-2">
                        <!-- Picked colors will be injected here -->
                    </div>
                    <p id="palette-prompt" class="text-sm text-gray-500 mt-2">Click on the image to pick a color.</p>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button id="copy-all-btn" class="w-full bg-white hover:bg-gray-200 text-black font-bold py-3 px-4 rounded-lg">Copy All Picked</button>
                    <button id="clear-palette-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg">Clear Palette</button>
                </div>
                <button id="remove-image-btn" class="w-full bg-red-800/20 hover:bg-red-800/40 text-red-400 text-sm font-medium py-2 rounded-lg hidden">Remove Image</button>
            </div>
        </div>
        <!-- Ad Sidebar -->
        <aside class="w-[20%] flex-shrink-0 p-3 border-l border-gray-800 hidden lg:block">
            <div class="h-full bg-gray-800/50 rounded-lg flex items-center justify-center text-gray-400">
                Ad Area
            </div>
        </aside>

        <!-- ADDED: Mobile/Tablet Navigation Bar -->
        <div id="mobile-nav" class="fixed bottom-0 left-0 w-full lg:hidden bg-gray-800 border-t border-gray-700 shadow-2xl z-40">
            <div class="flex justify-around items-center h-14">
                <button id="mobile-picker-btn" class="mobile-nav-btn flex flex-col items-center justify-center text-xs font-medium w-1/2 active">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg>
                    <span>Picker</span>
                </button>
                <button id="mobile-palette-btn" class="mobile-nav-btn flex flex-col items-center justify-center text-xs font-medium w-1/2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42m0 0a6.776 6.776 0 01-3.42 3.42m0 0a6.776 6.776 0 003.42 3.42m0 0a6.776 6.776 0 013.42-3.42m0 0l-3.42 3.42"></path></svg>
                    <span>Palette</span>
                </button>
            </div>
        </div>
    </main>

    <!-- MODIFIED: Footer hidden on mobile -->
    <footer class="p-4 w-full flex-shrink-0 border-t border-gray-200 dark:border-gray-700/50 hidden lg:block">
        <div class="flex flex-col sm:flex-row justify-between items-center text-gray-500 dark:text-gray-400 text-sm">
             <div class="flex items-center space-x-3 mb-4 sm:mb-0">
                <svg class="h-6 w-6 text-gray-400 dark:text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5L12 2z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 7l10 5 10-5"></path></svg>
                <span>© 2025 Solite. All Rights Reserved.</span>
            </div>
            <div class="flex items-center space-x-4">
                <a href="./privacy.html" class="hover:text-gray-900 dark:hover:text-white transition-colors">Privacy Policy</a>
                <a href="./terms.html" class="hover:text-gray-900 dark:hover:text-white transition-colors">Terms</a>
                <a href="mailto:support@solite.com" class="hover:text-gray-900 dark:hover:text-white transition-colors">Contact</a>
            </div>
        </div>
    </footer>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-0 left-1/2 -translate-x-1/2 bg-white text-black font-semibold py-2 px-5 rounded-t-lg shadow-lg">Copied!</div>
    
    <script>
        class ImageColorPicker {
            constructor() {
                this.ZOOM_FACTOR = 5;
                this.LOUPE_SIZE = 128;

                this.pickedColors = [];
                this._cacheDOMElements();
                this._attachEventListeners();
                this._handleInitialLayout(); // Add initial layout check
            }

            _cacheDOMElements() {
                this.imageContainer = document.getElementById('image-container'); // Container for canvas/prompt
                this.uploadPrompt = document.getElementById('upload-prompt');
                this.imageUpload = document.getElementById('image-upload');
                this.canvas = document.getElementById('image-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.colorInfoSection = document.getElementById('color-info-section');
                this.hoverColorPreview = document.getElementById('hover-color-preview');
                this.hoverColorHex = document.getElementById('hover-color-hex');
                this.hoverColorRgb = document.getElementById('hover-color-rgb');
                this.hoverColorHsl = document.getElementById('hover-color-hsl');
                this.pickedColorsPalette = document.getElementById('picked-colors-palette');
                this.palettePrompt = document.getElementById('palette-prompt');
                this.removeImageBtn = document.getElementById('remove-image-btn');
                this.toast = document.getElementById('toast');
                this.zoomLoupe = document.getElementById('zoom-loupe');
                this.contrastWhite = document.getElementById('contrast-white');
                this.contrastBlack = document.getElementById('contrast-black');
                this.contrastWhitePass = document.getElementById('contrast-white-pass');
                this.contrastBlackPass = document.getElementById('contrast-black-pass');

                // Panes for mobile view
                this.pickerPane = document.getElementById('picker-pane');
                this.palettePane = document.getElementById('palette-pane');
                this.mobilePickerBtn = document.getElementById('mobile-picker-btn');
                this.mobilePaletteBtn = document.getElementById('mobile-palette-btn');
            }

            _attachEventListeners() {
                // Keep existing upload/drag/drop listeners
                this.uploadPrompt.addEventListener('click', () => { this.imageUpload.click(); });
                this.imageUpload.addEventListener('change', (e) => this.handleImage(e.target.files[0]));
                this.pickerPane.addEventListener('dragover', (e) => { e.preventDefault(); this.pickerPane.classList.add('border-blue-500'); });
                this.pickerPane.addEventListener('dragleave', () => this.pickerPane.classList.remove('border-blue-500'));
                this.pickerPane.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.pickerPane.classList.remove('border-blue-500');
                    this.handleImage(e.dataTransfer.files[0]);
                });

                // Canvas interaction (mouse and touch)
                this.canvas.addEventListener('mouseenter', () => { this.zoomLoupe.style.display = 'block'; });
                this.canvas.addEventListener('mouseleave', () => { this.zoomLoupe.style.display = 'none'; });
                this.canvas.addEventListener('mousemove', (e) => this._handlePointerMove(e.clientX, e.clientY));
                this.canvas.addEventListener('click', (e) => this._handleCanvasClick(e.clientX, e.clientY));
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault(); // Prevent page scrolling
                    const touch = e.touches[0];
                    this._handlePointerMove(touch.clientX, touch.clientY);
                    this.zoomLoupe.style.display = 'block'; // Ensure loupe shows on touch
                }, { passive: false });
                 this.canvas.addEventListener('touchend', (e) => {
                     // Use changedTouches for touchend
                    if (e.changedTouches.length > 0) {
                        const touch = e.changedTouches[0];
                         this._handleCanvasClick(touch.clientX, touch.clientY);
                    }
                    this.zoomLoupe.style.display = 'none'; // Hide loupe on touch end
                 });


                // Palette actions
                document.getElementById('clear-palette-btn').addEventListener('click', () => this.clearPalette());
                document.getElementById('copy-all-btn').addEventListener('click', () => this.copyAllPickedColors());
                this.removeImageBtn.addEventListener('click', () => this.removeImage());

                // Event delegation for copy buttons
                this.palettePane.addEventListener('click', (e) => {
                    const copyBtn = e.target.closest('.copy-format-btn');
                    if (copyBtn) this._copyColorFormat(copyBtn.dataset.format);

                    // Handle clicks on palette swatches
                    const swatch = e.target.closest('.palette-swatch');
                    if(swatch) {
                        navigator.clipboard.writeText(swatch.dataset.color).then(() => this._showToast());
                    }
                });

                // Mobile Navigation
                this.mobilePickerBtn.addEventListener('click', () => this._showMobilePane('picker'));
                this.mobilePaletteBtn.addEventListener('click', () => this._showMobilePane('palette'));
                window.addEventListener('resize', () => this._handleMobileLayout());
            }

             _handlePointerMove(clientX, clientY) {
                const rect = this.canvas.getBoundingClientRect();
                const x = clientX - rect.left;
                const y = clientY - rect.top;

                 // Clamp coordinates to stay within canvas bounds
                const clampedX = Math.max(0, Math.min(x, this.canvas.width - 1));
                const clampedY = Math.max(0, Math.min(y, this.canvas.height - 1));

                if (clampedX >= 0 && clampedY >= 0 && clampedX < this.canvas.width && clampedY < this.canvas.height) {
                    try {
                        const pixel = this.ctx.getImageData(clampedX, clampedY, 1, 1).data;
                        this._updateColorInfo(pixel);
                        this._updateLoupe(clientX, clientY, clampedX, clampedY);
                    } catch (e) {
                        // Sometimes getImageData fails near edges if coordinates are slightly off
                        console.warn("Could not get pixel data at edge:", e);
                    }
                } else {
                    // Hide loupe if pointer is outside canvas bounds, even if technically over the element
                    this.zoomLoupe.style.display = 'none';
                }
            }


            _handleCanvasClick(clientX, clientY) {
                const rect = this.canvas.getBoundingClientRect();
                const x = clientX - rect.left;
                const y = clientY - rect.top;

                // Clamp coordinates
                const clampedX = Math.max(0, Math.min(x, this.canvas.width - 1));
                const clampedY = Math.max(0, Math.min(y, this.canvas.height - 1));

                if (clampedX >= 0 && clampedY >= 0 && clampedX < this.canvas.width && clampedY < this.canvas.height) {
                     try {
                        const pixel = this.ctx.getImageData(clampedX, clampedY, 1, 1).data;
                        const hex = this._rgbToHex(pixel[0], pixel[1], pixel[2]);
                        if (!this.pickedColors.includes(hex)) {
                            this.pickedColors.push(hex);
                            this.updatePalette();
                        }
                    } catch (e) {
                         console.warn("Could not pick color at edge:", e);
                    }
                }
            }


            handleImage(file) {
                if (!file || !file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Calculate dimensions to fit image within the container
                        const container = this.imageContainer;
                        const containerWidth = container.clientWidth - 16; // Account for padding
                        const containerHeight = container.clientHeight - 16;
                        const imgAspectRatio = img.width / img.height;
                        const containerAspectRatio = containerWidth / containerHeight;

                        let displayWidth, displayHeight;

                        if (imgAspectRatio > containerAspectRatio) {
                            // Image is wider than container, fit to width
                            displayWidth = containerWidth;
                            displayHeight = containerWidth / imgAspectRatio;
                        } else {
                            // Image is taller than or same aspect as container, fit to height
                            displayHeight = containerHeight;
                            displayWidth = containerHeight * imgAspectRatio;
                        }

                        this.canvas.width = displayWidth;
                        this.canvas.height = displayHeight;
                        this.ctx.drawImage(img, 0, 0, displayWidth, displayHeight);

                        this.uploadPrompt.classList.add('hidden');
                        this.canvas.classList.remove('hidden');
                        this.canvas.style.cursor = 'crosshair'; // Keep crosshair for picker
                        this.colorInfoSection.classList.remove('hidden');
                        this.removeImageBtn.classList.remove('hidden');
                        this.pickerPane.classList.remove('border-dashed', 'items-center', 'justify-center'); // Adjust picker pane appearance
                        this.pickerPane.classList.add('border-gray-900'); // Use solid border when image loaded

                        // Switch to picker pane on mobile after upload
                        if (window.innerWidth < 1024) {
                            this._showMobilePane('picker');
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            removeImage() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.canvas.classList.add('hidden');
                this.colorInfoSection.classList.add('hidden');
                this.removeImageBtn.classList.add('hidden');
                this.uploadPrompt.classList.remove('hidden');
                this.pickerPane.classList.add('border-dashed', 'items-center', 'justify-center'); // Re-add styles for prompt
                this.pickerPane.classList.remove('border-gray-900');
                this.clearPalette();
                this.imageUpload.value = ''; // Clear file input
                this.canvas.style.cursor = 'default';
            }

            clearPalette() {
                this.pickedColors = [];
                this.updatePalette();
            }

             _updateColorInfo(pixel) {
                if (!pixel) return; // Add safety check
                const [r, g, b] = pixel;
                const hex = this._rgbToHex(r, g, b);
                const hsl = this._hexToHsl(hex);

                this.hoverColorPreview.style.backgroundColor = hex;
                this.hoverColorHex.textContent = hex;
                this.hoverColorRgb.textContent = `${r}, ${g}, ${b}`;
                this.hoverColorHsl.textContent = `${hsl.h}, ${hsl.s}%, ${hsl.l}%`;

                const contrastWithWhite = this._getContrast([r, g, b], [255, 255, 255]);
                const contrastWithBlack = this._getContrast([r, g, b], [0, 0, 0]);

                this.contrastWhite.textContent = contrastWithWhite.toFixed(2);
                this.contrastWhitePass.textContent = contrastWithWhite >= 4.5 ? 'Pass' : 'Fail';
                this.contrastWhitePass.className = `font-bold ${contrastWithWhite >= 4.5 ? 'text-green-400' : 'text-red-400'}`;
                
                this.contrastBlack.textContent = contrastWithBlack.toFixed(2);
                this.contrastBlackPass.textContent = contrastWithBlack >= 4.5 ? 'Pass' : 'Fail';
                this.contrastBlackPass.className = `font-bold ${contrastWithBlack >= 4.5 ? 'text-green-400' : 'text-red-400'}`;
            }

            _updateLoupe(clientX, clientY, canvasX, canvasY) {
                // Adjust loupe position relative to the viewport
                this.zoomLoupe.style.left = `${clientX - this.LOUPE_SIZE / 2}px`;
                this.zoomLoupe.style.top = `${clientY - this.LOUPE_SIZE / 2}px`;

                this.zoomLoupe.style.backgroundImage = `url(${this.canvas.toDataURL()})`;
                this.zoomLoupe.style.backgroundSize = `${this.canvas.width * this.ZOOM_FACTOR}px ${this.canvas.height * this.ZOOM_FACTOR}px`;
                
                // Calculate background position based on canvas coordinates
                const bgX = -(canvasX * this.ZOOM_FACTOR - this.LOUPE_SIZE / 2);
                const bgY = -(canvasY * this.ZOOM_FACTOR - this.LOUPE_SIZE / 2);
                this.zoomLoupe.style.backgroundPosition = `${bgX}px ${bgY}px`;
            }

            updatePalette() {
                this.pickedColorsPalette.innerHTML = '';
                this.palettePrompt.classList.toggle('hidden', this.pickedColors.length > 0);

                this.pickedColors.forEach(color => {
                    const swatch = document.createElement('button');
                    // Add data-color attribute
                    swatch.className = 'palette-swatch relative w-8 h-8 rounded-md cursor-pointer border-2 border-gray-700 group';
                    swatch.style.backgroundColor = color;
                    swatch.title = `Click to copy ${color}`;
                    swatch.dataset.color = color; // Store color data
                    swatch.innerHTML = `<div class="absolute inset-0 flex items-center justify-center bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity"><span class="text-white text-xs font-mono">${color.substring(1)}</span></div>`;
                    // Event listener is now handled by delegation in _attachEventListeners
                    this.pickedColorsPalette.appendChild(swatch);
                });
            }


            _copyColorFormat(format) {
                let textToCopy = '';
                if (format === 'hex') textToCopy = this.hoverColorHex.textContent;
                else if (format === 'rgb') textToCopy = `rgb(${this.hoverColorRgb.textContent})`;
                else if (format === 'hsl') textToCopy = `hsl(${this.hoverColorHsl.textContent})`;

                navigator.clipboard.writeText(textToCopy).then(() => {
                    this._showToast(`${format.toUpperCase()} copied!`);
                });
            }

            copyAllPickedColors() {
                if (this.pickedColors.length === 0) return;
                const allColorsText = this.pickedColors.join('\n');
                navigator.clipboard.writeText(allColorsText).then(() => {
                    this._showToast('All colors copied!');
                });
            }

            _showToast(message = 'Copied!') {
                this.toast.textContent = message;
                this.toast.classList.add('show');
                setTimeout(() => {
                    this.toast.classList.remove('show');
                    if (message !== 'Copied!') {
                        setTimeout(() => { this.toast.textContent = 'Copied!'; }, 300);
                    }
                }, 1500);
            }

            // --- Mobile Layout Logic ---
            _showMobilePane(paneId) {
                if (paneId === 'picker') {
                    this.pickerPane.classList.remove('hidden');
                    this.palettePane.classList.add('hidden');
                    this.mobilePickerBtn.classList.add('active');
                    this.mobilePaletteBtn.classList.remove('active');
                } else { // 'palette'
                    this.pickerPane.classList.add('hidden');
                    this.palettePane.classList.remove('hidden');
                    this.mobilePickerBtn.classList.remove('active');
                    this.mobilePaletteBtn.classList.add('active');
                }
            }

            _handleMobileLayout() {
                if (window.innerWidth < 1024) {
                    // Check if a pane is explicitly shown, otherwise default to picker
                    const isPaletteVisible = !this.palettePane.classList.contains('hidden');
                    if (!isPaletteVisible) {
                        this._showMobilePane('picker');
                    }
                } else {
                    // Desktop: show both panes
                    this.pickerPane.classList.remove('hidden');
                    this.palettePane.classList.remove('hidden');
                    this.mobilePickerBtn.classList.remove('active'); // Ensure nav buttons are inactive
                    this.mobilePaletteBtn.classList.remove('active');
                }
            }

             _handleInitialLayout() {
                 this._handleMobileLayout(); // Run the check once on load
             }

            // --- Color Utility Functions ---
            _rgbToHex(r, g, b) { return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase(); }
            _hexToRgb(hex) { const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return r ? { r: parseInt(r[1], 16), g: parseInt(r[2], 16), b: parseInt(r[3], 16) } : null; }
            _hexToHsl(hex) {
                const rgb = this._hexToRgb(hex);
                if (!rgb) return { h: 0, s: 0, l: 0 }; // Return default if hex is invalid
                let { r, g, b } = rgb;
                r /= 255, g /= 255, b /= 255;
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;
                if (max === min) { h = s = 0; } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
            }
            _getLuminance(r, g, b) {
                const a = [r, g, b].map(v => { v /= 255; return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4); });
                return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
            }
            _getContrast(rgb1, rgb2) {
                const lum1 = this._getLuminance(rgb1[0], rgb1[1], rgb1[2]);
                const lum2 = this._getLuminance(rgb2[0], rgb2[1], rgb2[2]);
                const lighter = Math.max(lum1, lum2);
                const darker = Math.min(lum1, lum2);
                return (lighter + 0.05) / (darker + 0.05);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new ImageColorPicker();
        });
    </script>
</body>
</html>
